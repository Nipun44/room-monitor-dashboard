<!DOCTYPE html>
<html>
<head>
  <title>Room Monitor Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Roboto', sans-serif; 
      text-align: center; 
      padding: 20px; 
      background-color: #0a0a23; /* Dark background */
      color: #f0f0f0; /* Light grey text */
    }
    h1 { 
      font-family: 'Orbitron', sans-serif;
      font-size: 28px; /* Slightly larger */
      margin-bottom: 25px; 
      color: #00d0ff; /* Bright blue neon-like color */
      text-shadow: 0 0 5px #00d0ff, 0 0 10px #00d0ff, 0 0 15px #00d0ff; /* Neon glow effect */
    }
    .values {
      font-size: 22px; /* Slightly larger for prominence */
      margin-bottom: 20px;
      color: #e0e0e0; /* Lighter color for labels */
    }
    .values span { /* Targets <span> elements within .values for actual data */
      color: #ffffff; /* White for actual data */
      font-weight: bold;
    }
    /* Timestamp styling - label and value */
    #time-label {
        color: #b0b0b0; /* Softer grey for "Timestamp:" label part */
    }
    #time-value {
        color: #ffffff; /* White for actual data */
        font-weight: bold;
    }
    .charts-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .chart-wrapper {
      max-width: 400px;
      width: 100%;
      background-color: #1c1c3c; /* Darker shade for chart background */
      padding: 15px;
      border-radius: 8px; /* Rounded corners */
      border: 1px solid #00d0ff; /* Subtle border with accent color */
      box-shadow: 0 0 10px rgba(0, 208, 255, 0.3); /* Subtle glow for chart wrappers */
      transition: all 0.3s ease-in-out; /* Smooth transition for hover effects */
    }
    .chart-wrapper:hover {
      box-shadow: 0 0 15px rgba(0, 208, 255, 0.5); /* Enhanced glow on hover */
      transform: scale(1.02); /* Slightly scale up on hover */
    }
    .chart-title {
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
      margin-bottom: 10px; /* Increased margin */
      font-size: 20px; /* Larger chart title */
      color: #00d0ff; /* Accent color for chart titles */
    }
    canvas {
      max-height: 200px !important;
      height: 200px !important;
      width: 100% !important;
      border-radius: 4px; /* Slightly rounded corners for canvas */
    }
    #time-container { /* Container for timestamp label and value */
      font-size: 18px; /* Larger timestamp */
      margin-bottom: 30px;
      display: block;
    }
  </style>
</head>
<body>
  <h1>üìä Room Monitor</h1>

  <div class="values">
    üå° Temperature: <span id="temp">--</span> ¬∞C &nbsp;&nbsp; | &nbsp;&nbsp; üíß Humidity: <span id="hum">--</span> %
  </div>
  <div id="time-container"><span id="time-label">‚è± Timestamp: </span><span id="time-value">--</span></div>

  <div class="charts-container">
    <div class="chart-wrapper">
      <div class="chart-title">Temperature (¬∞C)</div>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <div class="chart-title">Humidity (%)</div>
      <canvas id="humChart"></canvas>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCHCmEo57ty3kLvZRay6BJ8Ie2PjSTnPDg",
      authDomain: "iot-project-baw-pal.firebaseapp.com",
      databaseURL: "https://iot-project-baw-pal-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iot-project-baw-pal",
      storageBucket: "iot-project-baw-pal.firebasestorage.app",
      messagingSenderId: "845069079178",
      appId: "1:845069079178:web:b877db653292ec2eb79373",
      measurementId: "G-THREY0M483"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let tempData = [];
    let humData = [];
    let labels = [];

    function formatTimestamp(ts) {
      if (!ts) return '--'; // Return placeholder if timestamp is null
      return ts.substr(0, 10) + ' ' + ts.substr(11, 8);
    }

    function updateLatest(data) {
      document.getElementById("temp").textContent = data.temperature.toFixed(2);
      document.getElementById("hum").textContent = data.humidity.toFixed(2);
      document.getElementById("time-value").textContent = formatTimestamp(data.timestamp); // Update time value span
    }

    const ctxTemp = document.getElementById('tempChart').getContext('2d');
    const ctxHum = document.getElementById('humChart').getContext('2d');

    const commonOptions = {
      responsive: true,
      animation: false,
      scales: {
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45,
            autoSkip: true,
            maxTicksLimit: 10,
            color: '#f0f0f0' // Light color for x-axis ticks
          },
          grid: {
            color: 'rgba(240, 240, 240, 0.1)' // Lighter grid lines for x-axis
          }
        },
        y: {
          beginAtZero: false,
          ticks: {
            color: '#f0f0f0' // Light color for y-axis ticks
          },
          grid: {
            color: 'rgba(240, 240, 240, 0.1)' // Lighter grid lines for y-axis
          }
        }
      },
      plugins: {
        legend: { 
            display: false,
            labels: {
                color: '#f0f0f0' 
            }
        },
        tooltip: { 
            mode: 'index', 
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.7)', 
            titleColor: '#00d0ff', 
            bodyColor: '#f0f0f0', 
            borderColor: '#00d0ff', 
            borderWidth: 1
        }
      }
    };

    const tempChart = new Chart(ctxTemp, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Temperature (¬∞C)',
          data: tempData,
          borderColor: '#39ff14', // Neon green
          backgroundColor: 'rgba(57, 255, 20, 0.25)', // Neon green transparent fill
          fill: true,
          tension: 0.3, 
          pointRadius: 0, 
          borderWidth: 2 
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          ...commonOptions.scales,
          y: {
            ...commonOptions.scales.y, 
            suggestedMin: 15,
            suggestedMax: 40,
          }
        }
      }
    });

    const humChart = new Chart(ctxHum, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Humidity (%)',
          data: humData,
          borderColor: '#ff00ff', // Neon pink
          backgroundColor: 'rgba(255, 0, 255, 0.25)', // Neon pink transparent fill
          fill: true,
          tension: 0.3, 
          pointRadius: 0, 
          borderWidth: 2 
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          ...commonOptions.scales,
          y: {
            ...commonOptions.scales.y, 
            suggestedMin: 20,
            suggestedMax: 80,
          }
        }
      }
    });

    const ref = db.ref("smarthome");
    ref.limitToLast(240).on("value", snapshot => {
      tempData = [];
      humData = [];
      labels = [];

      snapshot.forEach(childSnap => {
        const data = childSnap.val();
        if (data.temperature != null && data.humidity != null && data.timestamp) {
          tempData.push(parseFloat(data.temperature));
          humData.push(parseFloat(data.humidity));
          labels.push(data.timestamp.substr(11, 5)); // HH:MM
        }
      });

      tempChart.data.labels = labels;
      tempChart.data.datasets[0].data = tempData;
      tempChart.update();

      humChart.data.labels = labels;
      humChart.data.datasets[0].data = humData;
      humChart.update();

      const last = snapshot.val() ? Object.values(snapshot.val()).pop() : null;
      if (last) updateLatest(last);
      else { // Handle case where there's no data yet
        document.getElementById("temp").textContent = '--';
        document.getElementById("hum").textContent = '--';
        document.getElementById("time-value").textContent = '--';
      }
    });
  </script>
</body>
</html>
